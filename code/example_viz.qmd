---
title: "A spattering of things"
subtitle: "An offering of data visualizations"
format: 
  html:
    toc: true
    self-contained: true
editor: visual
---

```{r}
#| label: load data and libraries
#| echo: false
#| message: false
#| warning: false

# Libraries ----
library(here)
library(tidyverse)
library(gmRi)
library(matrixStats)
library(Hmisc)
library(patchwork)
library(broom)
library(grid)
library(gridExtra)
library(ggridges)
library(rnaturalearth)
library(sf)


# Data ---- 
dat <- read_rds(here("data", "trawldat_clean.rds")) |>
  mutate(decade = 10*year%/%10)

mid_atl_spp <- c("summer flounder", "black sea bass", "scup", "atlantic mackerel", "chub mackerel", "butterfish", "longfin squid", "northern shortfin squid", "atlantic surfclam", "ocean quahog", "atlantic bluefish", "tilefish", "blueline tilefish", "spiny dogfish", "goosefish")

# Shapefiles ----
sf_use_s2(FALSE)

shp_path <- here("CouncilBoundryCCC", "Council_Scopes.shp")

boundaries <- st_read(shp_path)
fortify(boundaries) -> boundaries 

east_coast <- boundaries |>
  filter(Council %in% c("New England", "Mid-Atlantic", "South Atlantic")) # |>
  # st_transform(., crs = 32619)

mid_atlantic <- east_coast |>
  filter(Council == "Mid-Atlantic")


```

```{r}
#| label: weighted functions
#| echo: false
#| warning: false
#| message: false

# Biomass weighted means ----
center_bio <- function(x, ...){
  x |>
    group_by(comname, ...) %>%
    summarise(
      # Un-weighted averages
      total_biomass   = sum(total_biomass_kg),
      avg_biomass     = mean(total_biomass_kg),
      biomass_sd      = sd(total_biomass_kg),
      # Weighted averages
      avg_lat         = weightedMean(lat, w = total_biomass_kg, na.rm = T),  
      avg_lon         = weightedMean(lon, w = total_biomass_kg, na.rm = T),
      avg_sst         = weightedMean(surftemp, w = total_biomass_kg, na.rm = T),
      avg_bot         = weightedMean(bottemp,  w = total_biomass_kg, na.rm = T),
      avg_depth       = weightedMean(depth, w = total_biomass_kg, na.rm = T),
      .groups = "drop")
}

# Biomass weighted latitude & lon percentiles ----
lat_percentiles_fn <- function(x, ...){
  x |> 
    group_by(comname,...) |>
    summarise(
        `5%`   = wtd.quantile(lat, weights = total_biomass_kg, probs = 0.05),
        `25%`  = wtd.quantile(lat, weights = total_biomass_kg, probs = 0.25),
        `50%`  = wtd.quantile(lat, weights = total_biomass_kg, probs = 0.50),
        `75%`  = wtd.quantile(lat, weights = total_biomass_kg, probs = 0.75),
        `95%`  = wtd.quantile(lat, weights = total_biomass_kg, probs = 0.95),
        .groups = "drop")
}

lon_percentiles_fn <- function(x, ...){
  x |> 
    group_by(comname,...) |>
    summarise(
        `5%`   = wtd.quantile(lon, weights = total_biomass_kg, probs = 0.05),
        `25%`  = wtd.quantile(lon, weights = total_biomass_kg, probs = 0.25),
        `50%`  = wtd.quantile(lon, weights = total_biomass_kg, probs = 0.50),
        `75%`  = wtd.quantile(lon, weights = total_biomass_kg, probs = 0.75),
        `95%`  = wtd.quantile(lon, weights = total_biomass_kg, probs = 0.95),
        .groups = "drop")
}

weighted_dat    <- center_bio(dat, year)
seasonal_dat    <- center_bio(dat, year, season)
lat_percentiles <- lat_percentiles_fn(dat, year)
lon_percentiles <- lon_percentiles_fn(dat, year)
```

```{r}
#| label: mid-atlantic managed spp
#| echo: false
#| warning: false
#| message: false

matl_dat <- weighted_dat |>
  filter(comname %in% mid_atl_spp) |>
  mutate(decade = 10*year%/%10) 

matl_perc <- lat_percentiles |>
  filter(comname %in% mid_atl_spp) |> 
  mutate(decade = 10*year%/%10)

```

```{r}
#| label: env parameter figs
#| echo: false
#| message: false
#| warning: false

# Lat, Lon, SST & BT ----
env_plots <- matl_dat |> 
  # mutate(decade = 10*year%/%10) |>
  pivot_longer(cols = avg_lat:avg_depth, names_to = "variable", values_to = "measurement") |>
  filter(!variable == "avg_depth") |> # add back in later
  mutate(label = case_when(
    variable == "avg_lat" ~ "Center of latitude",
    variable == "avg_lon" ~ "Center of longitude",
    variable == "avg_sst" ~ "Sea surface temperature",
    variable == "avg_bot" ~ "Bottom temperature" 
  )) |>
  select(comname, year, decade, variable, label, measurement) |>
  group_by(comname, label, decade) |>
  mutate(dec_avg = mean(measurement)) |>
  group_by(comname, label) |> 
  nest() |>
  mutate(plot = map(data, function(df){
    plot <- ggplot(data = df) +
      geom_line(aes(x=year, y=measurement), color = "#E9E9E9", linewidth = 0.8)+
      geom_point(aes(x = year, y = measurement), size=0.5) +
      ggtitle(label, subtitle = "Weighted by biomass") +
      theme_gmri(axis.title   = element_blank(),
                 plot.subtitle = element_text(size = 11))
    return(plot)}))

# env_plots$plot[[1]]

# Depth ----
depth_plots <- matl_dat |> 
  # mutate(decade = 10*year%/%10) |> 
  select(comname, year, decade, avg_depth) |>
  group_by(comname) |>
  nest() |>
  mutate(plot = map(data, function(df){
    plot <- ggplot(data = df) +
      geom_line(aes(x=year, y=avg_depth), color = "#E9E9E9", linewidth = 0.8)+
      geom_point(aes(x = year, y = avg_depth), size=0.5) +
      scale_y_reverse() +
      ggtitle("Depth", subtitle = "Weighted by biomass") +
      theme_gmri(axis.title   = element_blank(),
                 plot.subtitle = element_text(size = 11))
    return(plot)
  })) |>
  mutate(label = "Depth")

# Combine ----
env_plots |>
  full_join(depth_plots) |>
  arrange(comname) |>
  select(!data) -> env_plots
```

```{r}
#| label: percentiles & biomass
#| echo:  false
#| message: false
#| warning: false

# Latitude ----
all_percentiles <- lat_percentiles |> 
  filter(comname %in% mid_atl_spp) |>
  pivot_longer(cols = `5%`:`95%`, names_to = "percentile", values_to = "lat") |>
  mutate(factor = factor(percentile, levels = rev(c("5%","10%","25%","50%","75%","90%","95%")))) |>
  group_by(comname, percentile) |>
  mutate(roll_lat =  zoo::rollapplyr(lat, width = 5, FUN = mean, align = "center", partial = T)) |>
  group_by(comname) |>
  nest() |>
  mutate(lat = map2(data, comname, {function(x,y)
    out <- ggplot(data = x) +
      geom_line(aes(x = year, y = roll_lat, color = factor), linetype = 2, linewidth = 0.8) +
      geom_line(aes(x = year, y = lat, color = factor), alpha = 0.15) +
      guides(color = guide_legend(levels = c(`5%`, `25%`, `50%`, `75%`, `95%`), title = "Percentiles")) +
      ggtitle("Biomass-weighted latitude percentiles", subtitle = "5-year rolling mean represented by dashed line") +
      ylab("Latitude") + xlab("Year") +
      scale_color_gmri() +
      theme_gmri(plot.subtitle = element_text(size = 11)) 
    })) |>
  select(!data)

# Longitude (and combine) ----
lon_percentiles |> 
  filter(comname %in% mid_atl_spp) |>
  pivot_longer(cols = `5%`:`95%`, names_to = "percentile", values_to = "lon") |>
  mutate(factor = factor(percentile, levels = rev(c("5%","10%","25%","50%","75%","90%","95%")))) |>
  group_by(comname, percentile) |>
  mutate(roll_lon =  zoo::rollapplyr(lon, width = 5, FUN = mean, align = "center", partial = T)) |>
  group_by(comname) |>
  nest() |>
  mutate(lon = map2(data, comname, {function(x,y)
    out <- ggplot(data = x) +
      geom_line(aes(x = year, y = roll_lon, color = factor), linetype = 2, linewidth = 0.8) +
      geom_line(aes(x = year, y = lon, color = factor), alpha = 0.15) +
      guides(color = guide_legend(levels = c(`5%`, `25%`, `50%`, `75%`, `95%`), title = "Percentiles")) +
      ggtitle("Biomass-weighted longitude percentiles", subtitle = "5-year rolling mean represented by dashed line") +
      ylab("Longitude") + xlab("Year") +
      scale_color_gmri() +
      theme_gmri(plot.subtitle = element_text(size = 11)) 
    })) |>
  select(!data) |>
  left_join(all_percentiles) -> all_percentiles

```

```{r}
#| label: cog maps
#| echo: false
#| message: false
#| warning: false

usa <- ne_states("united states of america")
can <- ne_states("canada")

## Static ----
seasonal_dat |>
  filter(comname %in% mid_atl_spp) |>
  mutate(decade = 10*year%/%10) |>
  group_by(comname) |>
  nest() |>
  mutate(map = map2(data, comname, function(x,y){
    usa <- ne_states("united states of america")
    can <- ne_states("canada")
    ggplot() +
      geom_sf(data = usa) + geom_sf(data = can) +
      coord_sf(xlim = c(-66,-74), ylim = c(38,45)) +
      geom_point(data = x, aes(x = avg_lon, y = avg_lat, color = season)) +
      scale_x_continuous(breaks = c(-74,-70,-66)) + scale_y_continuous(breaks = c(38, 40, 42,44)) +
      ggtitle(str_to_sentence(comname)) +
      guides(color = guide_legend(title = "Season")) + 
      scale_color_gmri() + 
      facet_wrap(~decade, nrow = 1) +
      theme_gmri(panel.grid.major = element_blank(),
                 panel.border = element_rect(linetype = 1, color = "black"),
                 strip.background = element_blank(),
                 strip.text = element_text(color = "black"),
                 axis.line = element_blank(),
                 axis.title = element_blank(),
                 plot.margin = margin(0.1,1,0.1,1, unit = "mm"), #t,r,b,l
                 text = element_text(family = "sans"))
  })) -> static_maps

# trying different layouts (cuz I'm bored)
# spp <- weighted_dat |> 
#   filter(comname == "american lobster")
# 
# ggplot() +
#   geom_sf(data = usa, fill = "#535353", color = "black") + geom_sf(data = can, fill = "#535353", color = "black") +
#   coord_sf(xlim = c(-66,-74), ylim = c(38,45)) +
#   geom_point(data = spp, aes(x = avg_lon, y = avg_lat, color = year), size = 3) +
#   scale_color_gradient(low = "#004966", high = "#b94a40", na.value = "#e9e9e9") +
#   scale_x_continuous(breaks = c(-74,-70,-66)) + scale_y_continuous(breaks = c(38, 40, 42,44)) +
#   theme_gmri(
#     panel.grid.major = element_blank(),
#     panel.border = element_rect(color = "black", linetype = 1),
#     panel.background = element_rect(fill = "#e6e6e6")
#   )
```

```{r}
#| label: animated plots
#| echo: false
#| message: false
#| warning: false

## Animated ----
# example #1
atl_mack <- seasonal_dat |>
  filter(comname == "atlantic mackerel")

ggplot() + 
  geom_sf(data = usa) + geom_sf(data = can) +
  coord_sf(xlim = c(-66,-74), ylim = c(38,45)) +
  geom_point(data = atl_mack, aes(x = avg_lon, y = avg_lat, color = season)) +
  scale_x_continuous(breaks = c(-74,-70,-66)) + scale_y_continuous(breaks = c(38, 40, 42,44)) +
  guides(color = guide_legend(title = "Season")) + 
  scale_color_gmri() + 
  theme_gmri(panel.grid.major = element_blank(),
             panel.border = element_rect(linetype = 1, color = "black"),
             axis.line = element_blank(),
             axis.title = element_blank(),
             plot.margin = margin(0.1,1,0.1,1, unit = "mm"), #t,r,b,l
             text = element_text(family = "sans"))  -> map_stat

# map_stat +
#   gganimate::transition_states(
#     year, # Uses each year (est_year in the data) as a state
#     transition_length = 1,
#     state_length = 10) +
#     gganimate::shadow_mark(alpha = 0.1, size = 8) +
#     gganimate::ease_aes('linear') +
#   labs(
#     # y = "Latitude",
#     # x = "Longitude",
#     title = "Atlantic mackerel center of biomass",
#     subtitle = 'Year: {closest_state}') -> map_ani
# 
# gganimate::animate(map_ani, fps = 10, width = 4, height = 4, units = "in", res = 250) -> map_final
# gganimate::anim_save(here("atl_mack.gif"), map_final)

# knitr::include_graphics(here::here("atl_mack.gif"))

# example #2 
atl_croak <- seasonal_dat |>
  filter(comname == "atlantic croaker")

ggplot() + 
  geom_sf(data = usa) + geom_sf(data = can) +
  coord_sf(xlim = c(-70,-80), ylim = c(34,42)) +
  # geom_line(data = alewife, aes(x = avg_lon, y = avg_lat, group = year)) +
  geom_point(data = atl_croak, aes(x = avg_lon, y = avg_lat, color = season)) +
  scale_x_continuous(breaks = c(-80,-75,-70)) + scale_y_continuous(breaks = c(34, 38, 42)) +
  guides(color = guide_legend(title = "Season")) + 
  scale_color_gmri() + 
  theme_gmri(panel.grid.major = element_blank(),
             panel.border = element_rect(linetype = 1, color = "black"),
             axis.line = element_blank(),
             axis.title = element_blank(),
             plot.margin = margin(0.1,1,0.1,1, unit = "mm"), #t,r,b,l
             text = element_text(family = "sans"))  -> map_stat

# map_stat +
#   gganimate::transition_states(
#     year, # Uses each year (est_year in the data) as a state
#     transition_length = 1,
#     state_length = 10) +
#     gganimate::shadow_mark(alpha = 0.1, size = 8) +
#     gganimate::ease_aes('linear') +
#   labs(
#     # y = "Latitude",
#     # x = "Longitude",
#     title = "Atlantic croaker center of biomass",
#     subtitle = 'Year: {closest_state}') -> map_ani
# 
# gganimate::animate(map_ani, fps = 10, width = 4, height = 4, units = "in", res = 250) -> map_final
# gganimate::anim_save(here("atl_croak.gif"), map_final)

# knitr::include_graphics(here::here("atl_croak.gif"))


```

```{r}
#| label: proportions of biomass
#| echo: false
#| message: false

# Lat bins ----
decade_perc <- lat_percentiles_fn(dat, decade)
lat_bins <- decade_perc |>
  filter(comname %in% mid_atl_spp)

dat |>
  filter(comname %in% mid_atl_spp) |>
  select(comname, year, decade, lat, total_biomass_kg) |>
  mutate(lat = round(lat, digits = 1)) |>
  group_by(comname, decade, lat) |>
  summarise(biomass = mean(total_biomass_kg)) -> avg_biomass

avg_biomass |> 
  left_join(lat_bins |> select(comname, decade, `5%`, `95%`)) |>
  mutate(partitions = case_when(
    lat <= `5%` ~ "5%",
    lat >= `95%` ~ "95%",
    lat > `5%` & lat < `95%` ~ "center80%"
  ),
        factor = factor(partitions, levels = c("5%","center80%","95%"), labels = c("5%", "Center 80%", "95%"))) |>
  group_by(comname) |>
  nest() |>
  mutate(biomass_bins = map2(data, comname, function(x,y){
    ggplot(x) +
      geom_col(aes(x = biomass, y = as.factor(lat), fill = factor)) +
      geom_vline(xintercept = 0, color = "#535353", linewidth = 0.15) +
      scale_fill_manual(values = c("#00608A", "gray", "#b94a40")) +
      guides(fill = guide_legend(title = "Biomass percentiles")) +
      scale_y_discrete(breaks = c(34,36,38,40,42,44)) +
      ggtitle("Latitudinal bins") +
      xlab("Biomass") + ylab("Latitude") +
      facet_grid(~decade) +
      theme_gmri(strip.background = element_blank(),
                 legend.position = "bottom",
                axis.line.x = element_line(color = "#535353", linewidth = 0.15),
                strip.text = element_text(color = "black"),
                panel.grid = element_line(linetype = 3, color = "#535353", linewidth = 0.1))
  })) |>
  select(!data) -> biomass_plots


# Density ridges ----
# copied over from nmfs code
ridge_plots <- weighted_dat |>
  filter(comname %in% mid_atl_spp) |> 
  mutate(decade = 10*year %/% 10) |>
  group_by(comname) |>
  nest() |>
  mutate(ridge_plot = map2(data, comname, function(x,y){
    plot <- ggplot(data = x) +
      geom_density_ridges(aes(x = avg_lat, y = decade, fill = as.factor(decade)), alpha = .9) +
      coord_flip() +
      ylim(c(1970, NA)) + xlim(c(34,46)) +
      guides(fill = guide_legend(title = "Decade", nrow = 1)) +
      xlab("Latitude") + ggtitle("Latitudinal density", subtitle = "Biomass weighted average latitude") + 
      scale_fill_gmri() +
      theme_gmri(legend.position = "bottom",
               plot.subtitle = element_text(size = 12),
               axis.title.x = element_blank()) 
    return(plot)
  })) |>
  select(!data)

```

```{r}
#| label: species profiles
#| echo: false
#| message: false
#| warning: false
#| fig-align: center

library(grid)
library(gridExtra)

env_plots |>
  pivot_wider(names_from = "label", values_from = plot) |>
  left_join(all_percentiles) |>
  left_join(biomass_plots) |>
  left_join(ridge_plots) -> species_profiles
  # group_by(comname) |>
  # nest() |>
  # mutate(species_profile = map2(data, comname, function(x,y){
  #   cen_lat  <- x$`Center of latitude`[[1]]
  #   cen_lon  <- x$`Center of longitude`[[1]]
  #   sst      <- x$`Sea surface temperature`[[1]]
  #   bt       <- x$`Bottom temperature`[[1]]
  #   depth    <- x$`Depth`[[1]]
  #   lat_per  <- x$`lat`[[1]]
  #   lon_per  <- x$`lon`[[1]]
  #   biom_bin <- x$`biomass_bins`[[1]]
  #   ridges   <- x$`ridge_plots`[[1]]
  # 
  #   # row_1 <- grid.arrange(cen_lat, cen_lon, nrow = 1, layout_matrix=rbind(c(1,2)), top = textGrob(paste(str_to_sentence(comname)), gp = gpar(col = "black", fontsize = 15, fontface = "bold")))
  #   # row_2 <- grid.arrange(sst, bt, depth, nrow = 1, layout_matrix=rbind(c(1,2,3)))
  #   # row_3_4 <- grid.arrange(lat_per, lon_per, nrow = 2, layout_matrix=rbind(c(1,1), c(2,2)))
  #   # out <- grid.arrange(row_1, row_2, row_3_4, nrow = 4)
  # })) -> spp_profiles_env

```
### Atlantic mackerel
```{r}
#| label: example animated map
#| echo: false
#| message: false
#| warning: false
#| fig-width: 3
#| fig-height: 3

knitr::include_graphics(here::here("atl_mack.gif"))

```

```{r}
#| label: example dist plots
#| echo: false
#| message: false
#| warning: false

species_profiles |>
  filter(comname == "atlantic mackerel") -> x

static_maps |>
  filter(comname == "atlantic mackerel") ->  mack_map

map <- static_maps$map[static_maps$comname == "atlantic mackerel"][[1]]

cen_lat  <- x$`Center of latitude`[[1]]
cen_lon  <- x$`Center of longitude`[[1]]
lat_per  <- x$`lat`[[1]]
lon_per  <- x$`lon`[[1]]


grid.arrange(map, cen_lat, cen_lon, lat_per, lon_per, nrow = 4, layout_matrix=rbind(c(1,1), c(2,3), c(4,4), c(5,5)))

```

```{r}
#| label: example biomass plots
#| echo: false
#| message: false
#| warning: false


species_profiles |>
  filter(comname == "atlantic mackerel") -> x

biom_bin <- x$`biomass_bins`[[1]]
ridges   <- x$`ridge_plot`[[1]]


grid.arrange(biom_bin, ridges, nrow = 1)
```


